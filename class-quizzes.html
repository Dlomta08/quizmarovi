<!DOCTYPE html>
<html lang="ka" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>კლასის ტესტები</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="quiz-pages.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
    </script>
    <style>
        /* status dot on cards */
        .status-icon{ color:#d0d0d0; transition: color .2s ease; font-size:12px; }
        .status-icon.done{ color:#28a745; }
        .quiz-card{ position:relative; }
        .quiz-card .status-icon{ position:absolute; top:10px; right:10px; }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-content">
            <a href="page2.html" class="logo">
                <i class="fas fa-arrow-left"></i>
                <span>უკან დაბრუნება</span>
            </a>
            <button id="toggle-dark" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </nav>
    
    <div class="quiz-container">
        <div class="page-header">
            <h1 class="text-title"></h1>
        </div>

        <div class="years-grid" id="yearsGrid">
            <script>
            // ===== helpers for DONE state (matches quiz page keys) =====
            function hasAnyDoneKey(prefix){
              // Look for ANY localStorage key that starts with our prefix and is "true"
              for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k && k.startsWith(prefix) && localStorage.getItem(k) === 'true') {
                  return true;
                }
              }
              return false;
            }
            function refreshAllStatusIcons(){
              document.querySelectorAll('.status-icon[data-keyprefix]').forEach(icon=>{
                const prefix = icon.getAttribute('data-keyprefix');
                const done = hasAnyDoneKey(prefix);
                icon.classList.toggle('done', done);
                icon.title = done ? 'დასრულებულია' : 'არ არის დასრულებული';
                icon.setAttribute('aria-label', icon.title);
              });
            }

            // Get class number from URL
            const urlParams = new URLSearchParams(window.location.search);
            const classNum = parseInt(urlParams.get('class')) || 7;
            
            // Update page title
            document.title = `${classNum}-ე კლასის ტესტები`;
            document.querySelector('.text-title').textContent = 
                classNum === 1 ? '1-ლი კლასის ტესტები' : 
                `მე-${classNum} კლასის ტესტები`;
            
            const startYear = 2020;
            const endYear = 2024;
            const quizzesPerYear = 5;
            const yearsGrid = document.getElementById("yearsGrid");
            
            for (let y = endYear; y >= startYear; y--) {
                const academicYear = `${y}/${(y + 1).toString().slice(-2)}`;
                const yearFolderForKey = academicYear.replace("/", "-"); // matches quiz.html ?year=
                
                // Create year section
                const yearSection = document.createElement("div");
                yearSection.className = "year-section";
                
                // Year header
                const yearHeader = document.createElement("div");
                yearHeader.className = "year-header";
                const yearIcon = document.createElement("i");
                yearIcon.className = "fas fa-calendar-alt";
                const yearTitle = document.createElement("h2");
                yearTitle.textContent = `${academicYear} სასწავლო წელი`;
                yearHeader.appendChild(yearIcon);
                yearHeader.appendChild(yearTitle);
                
                // Quizzes grid
                const quizzesGrid = document.createElement("div");
                quizzesGrid.className = "quizzes-grid";
                
                for (let q = 1; q <= quizzesPerYear; q++) {
                    const quizCard = document.createElement("div");
                    quizCard.className = "quiz-card";
                    quizCard.onclick = () => handleQuizClick(academicYear, q, classNum);
                    
                    const quizIcon = document.createElement("i");
                    quizIcon.className = "fas fa-file-alt quiz-icon";
                    
                    const quizNumber = document.createElement("span");
                    quizNumber.className = "quiz-number";
                    quizNumber.textContent = q;
                    
                    const quizTitle = document.createElement("h3");
                    quizTitle.textContent = q === 1 ? `1-ლი ქვიზი` : `მე-${q} ქვიზი`;
                    
                    // The tiny white circle (turns green when done)
                    const statusIcon = document.createElement("i");
                    statusIcon.className = "fas fa-circle status-icon";
                    // Build a key *prefix* that matches how quiz.html stores done:
                    // quiz page uses: done-${class}-${yearFolder}-${number}-${category?}
                    // We don't know category here, so we match any with this prefix.
                    const keyPrefix = `done-${classNum}-${yearFolderForKey}-${q}`;
                    statusIcon.setAttribute('data-keyprefix', keyPrefix);

                    // initial paint from localStorage
                    if (hasAnyDoneKey(keyPrefix)) {
                        statusIcon.classList.add('done');
                        statusIcon.title = 'დასრულებულია';
                        statusIcon.setAttribute('aria-label', 'დასრულებულია');
                    } else {
                        statusIcon.title = 'არ არის დასრულებული';
                        statusIcon.setAttribute('aria-label', 'არ არის დასრულებული');
                    }
                    
                    quizCard.appendChild(quizIcon);
                    quizCard.appendChild(quizNumber);
                    quizCard.appendChild(quizTitle);
                    quizCard.appendChild(statusIcon);
                    quizzesGrid.appendChild(quizCard);
                }
                
                yearSection.appendChild(yearHeader);
                yearSection.appendChild(quizzesGrid);
                yearsGrid.appendChild(yearSection);
            }

            // If the DONE flag changes in another tab, update icons here
            window.addEventListener('storage', (e)=>{
              if (e.key && e.key.startsWith('done-')) {
                refreshAllStatusIcons();
              }
            });
            </script>
        </div>
    </div>

    <footer class="main-footer">
        <p>&copy; 2025 კომაროვის სკოლა. ყველა უფლება დაცულია.</p>
    </footer>

    <script>
        function handleQuizClick(year, number, classNum) {
            const yearFolder = year.replace("/", "-");
            const url = `quiz.html?class=${classNum}&year=${yearFolder}&number=${number}`;
            window.location.href = url;
        }
    </script>
    <script src="darkmode.js"></script>
</body>
</html>
